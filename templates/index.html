<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Statistics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
        }
        .plot-container {
            height: 400px;
        }
        .unknown-data {
            color: #dc3545;
            font-style: italic;
        }
        .allergy-tag {
            display: inline-block;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 2px 8px;
            margin: 2px;
        }
        .medication-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .missing-value {
            color: #dc3545;
            font-style: italic;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">Patient Statistics Dashboard</span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Patient Table -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Patient Overview</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Birth Date</th>
                                <th>Age</th>
                                <th>Height</th>
                                <th>Weight</th>
                                <th>BMI</th>
                                <th>Tumor Status</th>
                                <th>ECOG</th>
                                <th>Allergies</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for patient in patients %}
                            <tr>
                                <td class="{{ 'missing-value' if not patient.get('name') }}">{{ patient.get('name', 'No name') }}</td>
                                <td class="{{ 'missing-value' if not patient.get('birth_date') }}">{{ patient.get('birth_date', 'No birth date') }}</td>
                                <td class="{{ 'missing-value' if not patient.get('age') }}">{{ patient.get('age', 'No age') }}</td>
                                <td class="{{ 'missing-value' if not patient.get('height') }}">{{ patient.get('height', 'No height') }}</td>
                                <td class="{{ 'missing-value' if not patient.get('weight') }}">{{ patient.get('weight', 'No weight') }}</td>
                                <td class="{{ 'missing-value' if not patient.get('bmi') }}">{{ patient.get('bmi', 'No BMI') }}</td>
                                <td class="{{ 'missing-value' if not patient.get('tumor_status') }}">{{ patient.get('tumor_status', 'No tumor status') }}</td>
                                <td class="{{ 'missing-value' if not patient.get('ecog') }}">{{ patient.get('ecog', 'No ECOG') }}</td>
                                <td>
                                    {% if patient.get('allergies') %}
                                        {% for allergy in patient['allergies'] %}
                                            <span class="allergy-tag">{{ allergy }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="missing-value">No allergies reported</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ECOG Plot -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ECOG Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div id="ecog-plot" class="plot-container"></div>
                    </div>
                </div>
            </div>

            <!-- Tumor Stage Plot -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Tumor Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div id="tumor-plot" class="plot-container"></div>
                    </div>
                </div>
            </div>

            <!-- BMI Plot -->
            {% if bmi_plot %}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">BMI Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div id="bmi-plot" class="plot-container"></div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Age Distribution -->
            {% if age_plot %}
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Age Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div id="age-plot" class="plot-container"></div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Allergy Statistics -->
        {% if allergy_stats %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Common Allergies</h5>
            </div>
            <div class="card-body">
                {% for allergy, count in allergy_stats.items() %}
                    <span class="allergy-tag">{{ allergy }} ({{ count }})</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Detailed Patient Information -->
        <div class="row mt-4">
            {% for patient in patients %}
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">{{ patient.get('name', 'Unknown Patient') }}</h5>
                    </div>
                    <div class="card-body">
                        {% if patient.get('diagnoses') %}
                        <h6>Diagnoses:</h6>
                        <pre class="bg-light p-2">{{ patient['diagnoses'] }}</pre>
                        {% else %}
                        <h6>Diagnoses:</h6>
                        <p class="missing-value">No diagnoses information available</p>
                        {% endif %}

                        {% if patient.get('medications') %}
                        <h6>Medications:</h6>
                        <div class="medication-list">
                            <pre class="bg-light p-2">{{ patient['medications'] }}</pre>
                        </div>
                        {% else %}
                        <h6>Medications:</h6>
                        <p class="missing-value">No medications information available</p>
                        {% endif %}

                        {% if patient.get('pd_l1') %}
                        <h6>PD-L1 Status:</h6>
                        <p>{{ patient['pd_l1'] }}</p>
                        {% else %}
                        <h6>PD-L1 Status:</h6>
                        <p class="missing-value">No PD-L1 status available</p>
                        {% endif %}

                        {% if patient.get('tumor_size') %}
                        <h6>Tumor Size:</h6>
                        <p>{{ patient['tumor_size'] }}</p>
                        {% else %}
                        <h6>Tumor Size:</h6>
                        <p class="missing-value">No tumor size information available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Create the plots
        Plotly.newPlot('ecog-plot', {{ ecog_plot | safe }});
        Plotly.newPlot('tumor-plot', {{ tumor_plot | safe }});
        {% if bmi_plot %}
        Plotly.newPlot('bmi-plot', {{ bmi_plot | safe }});
        {% endif %}
        {% if age_plot %}
        Plotly.newPlot('age-plot', {{ age_plot | safe }});
        {% endif %}
    </script>
</body>
</html> 